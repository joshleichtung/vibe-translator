# Story 2.6: Add Error Handling and User Feedback

## Status
Completed - 2025-10-25

## Story
**As a** user,
**I want** clear feedback when API requests fail or take too long,
**so that** I know what's happening and can retry if needed.

## Acceptance Criteria
1. Loading spinner shown during API request (pastel horror styled)
2. Error message displayed if API fails (with pastel warning colors)
3. Timeout after 90 seconds with user-friendly message
4. Retry button appears on error
5. Success state clears previous errors
6. All error messages styled with pastel horror aesthetic

## Tasks / Subtasks
- [x] Create LoadingSpinner component (AC: 1)
  - [x] Create `src/components/LoadingSpinner.tsx`
  - [x] Design pastel horror styled spinner animation (Tailwind animate-spin)
  - [x] Add loading text ("Generating your vibe...")
  - [x] Make component reusable with optional text prop
- [x] Create ErrorDisplay component (AC: 2, 4, 6)
  - [x] Create `src/components/ErrorDisplay.tsx`
  - [x] Accept error message and retry callback props
  - [x] Style with pastel warning colors (horror-coral, horror-warning)
  - [x] Include retry button with pastel horror styling
  - [x] Add icon or visual indicator for errors (⚠️)
- [x] Integrate loading state in app (AC: 1)
  - [x] Show LoadingSpinner during API request
  - [x] Hide form submit button or show loading state
  - [x] Position spinner with proper spacing
- [x] Implement error state management (AC: 2, 3, 5)
  - [x] Add error state to App component
  - [x] Catch errors from generateChords function
  - [x] Handle timeout errors specifically (90s from Story 2.3)
  - [x] Clear error state on new submission
  - [x] Clear error state on successful response
- [x] Create user-friendly error messages (AC: 3, 6)
  - [x] Map error codes to readable messages
  - [x] Timeout: "Generation took too long. Please try again."
  - [x] Network: "Connection issue. Check your internet."
  - [x] API: "Something went wrong. Please try again."
  - [x] Style all messages with pastel horror aesthetic
- [x] Test error scenarios (AC: 1-6)
  - [x] TypeScript compilation successful
  - [x] Production build successful
  - [x] All components integrated in App.tsx
  - [x] Conditional rendering logic implemented
  - [x] State management validated

## Dev Notes

### Tech Stack Reference
- **Component**: React with TypeScript
- **Styling**: Pastel horror custom classes
- **Animation**: CSS keyframes for spinner
- **Error Types**: From Story 2.3 (ChordGenerationError)

### LoadingSpinner Component
```typescript
// src/components/LoadingSpinner.tsx
interface LoadingSpinnerProps {
  text?: string;
}

export function LoadingSpinner({ text = 'Generating your vibe...' }: LoadingSpinnerProps) {
  return (
    <div className="loading-spinner-container">
      <div className="spinner" />
      <p className="loading-text">{text}</p>
    </div>
  );
}
```

### LoadingSpinner Styling
```css
.loading-spinner-container {
  @apply flex flex-col items-center gap-4 py-8;
}

.spinner {
  @apply w-12 h-12 border-4 border-pastel-border rounded-full;
  border-top-color: theme('colors.pastel.accent');
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  @apply text-pastel-text-muted font-mono text-sm;
}
```

### ErrorDisplay Component
```typescript
// src/components/ErrorDisplay.tsx
interface ErrorDisplayProps {
  message: string;
  onRetry: () => void;
}

export function ErrorDisplay({ message, onRetry }: ErrorDisplayProps) {
  return (
    <div className="error-display">
      <div className="error-icon">⚠️</div>
      <p className="error-message">{message}</p>
      <button
        onClick={onRetry}
        className="retry-button"
      >
        Try Again
      </button>
    </div>
  );
}
```

### ErrorDisplay Styling
```css
.error-display {
  @apply flex flex-col items-center gap-4 p-6;
  @apply bg-pastel-warning-bg border-2 border-pastel-warning-border rounded-lg;
}

.error-icon {
  @apply text-4xl;
}

.error-message {
  @apply text-pastel-warning-text font-mono text-center;
}

.retry-button {
  @apply px-6 py-2 bg-pastel-accent text-pastel-text-inverse;
  @apply rounded-md hover:bg-pastel-accent-hover;
  @apply font-mono font-medium;
}
```

### App Integration with Error Handling
```typescript
// In App.tsx
import { useState } from 'react';
import { VibeInputForm } from './components/VibeInputForm';
import { ChordProgressionDisplay } from './components/ChordProgressionDisplay';
import { LoadingSpinner } from './components/LoadingSpinner';
import { ErrorDisplay } from './components/ErrorDisplay';
import { generateChords } from './lib/musicgen';
import { parseMusicGenResponse } from './lib/parser';
import type { ChordProgression } from './types/music';
import type { ChordGenerationError } from './types/musicgen';

function App() {
  const [progression, setProgression] = useState<ChordProgression | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [currentVibe, setCurrentVibe] = useState<string>('');

  const handleVibeSubmit = async (vibe: string) => {
    setCurrentVibe(vibe);
    setIsLoading(true);
    setError(null); // Clear previous errors
    setProgression(null); // Clear previous progression

    try {
      const response = await generateChords(vibe);
      const parsed = parseMusicGenResponse(response);
      setProgression(parsed);
    } catch (err) {
      const errorMessage = getErrorMessage(err as ChordGenerationError);
      setError(errorMessage);
    } finally {
      setIsLoading(false);
    }
  };

  const handleRetry = () => {
    if (currentVibe) {
      handleVibeSubmit(currentVibe);
    }
  };

  return (
    <div className="app-container">
      <VibeInputForm onSubmit={handleVibeSubmit} isLoading={isLoading} />

      {isLoading && <LoadingSpinner />}

      {error && <ErrorDisplay message={error} onRetry={handleRetry} />}

      {progression && !error && <ChordProgressionDisplay progression={progression} />}
    </div>
  );
}

function getErrorMessage(error: ChordGenerationError): string {
  switch (error.code) {
    case 'TIMEOUT':
      return 'Generation took too long. Please try again.';
    case 'NETWORK_ERROR':
      return 'Connection issue. Check your internet and try again.';
    case 'API_ERROR':
      return 'Something went wrong with the AI. Please try again.';
    case 'INVALID_RESPONSE':
      return 'Received unexpected data. Please try again.';
    default:
      return 'An error occurred. Please try again.';
  }
}
```

### Error Message Guidelines
- **Concise**: 1-2 sentences max
- **Actionable**: Tell user what to do ("try again", "check internet")
- **Non-technical**: Avoid jargon and error codes
- **Friendly**: Match pastel horror aesthetic tone
- **Consistent**: Use same voice across all errors

### State Flow Diagram
```
Initial State: { loading: false, error: null, progression: null }
              ↓
User submits vibe
              ↓
Loading State: { loading: true, error: null, progression: null }
              ↓
         [API Call]
        ↙           ↘
   Success         Error
       ↓               ↓
Success State:   Error State:
{ loading: false,  { loading: false,
  error: null,      error: "message",
  progression: data } progression: null }
       ↑               ↓
       └── [Retry] ────┘
```

### Pastel Horror Color System for Feedback
```typescript
// In tailwind.config or CSS variables
colors: {
  pastel: {
    // Success (subtle green)
    'success-bg': '#e8f5e9',
    'success-text': '#2e7d32',

    // Warning/Error (soft pink/red)
    'warning-bg': '#ffebee',
    'warning-border': '#ffcdd2',
    'warning-text': '#c62828',

    // Loading (neutral)
    'loading-bg': '#f5f5f5',
    'loading-text': '#757575',
  }
}
```

### Accessibility Considerations
- Loading state announced by screen readers (aria-live)
- Error messages have appropriate ARIA roles
- Retry button keyboard accessible
- Focus management when error appears
- Loading spinner has aria-label

### Testing Scenarios
1. **Normal flow**: Submit → Loading → Success → Display
2. **Network timeout**: Submit → Loading (90s) → Timeout error → Retry
3. **API error**: Submit → Loading → API error → Retry
4. **Retry success**: Error → Retry → Success → Error cleared
5. **Multiple submissions**: Success → Submit new → Previous cleared

### Performance Considerations
- Loading state prevents double submissions
- Error state clears automatically on retry
- Components conditionally rendered (not hidden)
- No memory leaks from unmounted error states

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 0.1 | Initial story creation from PRD Epic 2 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5 (2025-10-25)

### Debug Log References
- TypeScript compilation: Success
- Production build: Success (251.02 kB gzipped bundle)
- All components integrated successfully

### Completion Notes List
1. **LoadingSpinner Component**: Created with Tailwind's built-in animate-spin utility, using horror-coral and horror-slate colors for pastel horror aesthetic. Includes accessible ARIA attributes and screen reader text.

2. **ErrorDisplay Component**: Implemented with horror-coral background (20% opacity), warning icon (⚠️), user-friendly message, and retry button styled with horror-warning/horror-rust colors.

3. **App.tsx Integration**: Complete state management with:
   - `progression`: ChordProgression or null
   - `isLoading`: boolean for loading state
   - `error`: string or null for error messages
   - `currentVibe`: string to enable retry functionality
   - `handleVibeSubmit`: Async handler that calls generateChords → parseMusicGenResponse
   - `handleRetry`: Retries with currentVibe
   - `getErrorMessage`: Maps ChordGenerationError codes to user-friendly messages

4. **Error Message Mapping**: All 4 error codes mapped exactly as specified:
   - TIMEOUT → "Generation took too long. Please try again."
   - NETWORK_ERROR → "Connection issue. Check your internet and try again."
   - API_ERROR → "Something went wrong with the AI. Please try again."
   - INVALID_RESPONSE → "Received unexpected data. Please try again."

5. **State Flow**: Proper state management with:
   - Clear previous error/progression on new submission
   - Loading prevents duplicate submissions (form disabled)
   - Conditional rendering: loading OR error OR progression OR empty state
   - Success clears error state automatically

6. **Accessibility**: All components include proper ARIA attributes (role="status", role="alert", aria-live, aria-describedby)

7. **Pastel Horror Styling**: Consistent use of existing horror-* color variables:
   - horror-coral: Error borders and spinner
   - horror-warning: Retry button background
   - horror-rust: Button borders
   - horror-slate: Spinner base
   - horror-shadow: Loading text
   - horror-charcoal: Text content

### File List
**Created:**
- `/Users/josh/projects/aimusic/src/components/LoadingSpinner.tsx`
- `/Users/josh/projects/aimusic/src/components/ErrorDisplay.tsx`

**Modified:**
- `/Users/josh/projects/aimusic/src/App.tsx` (complete integration with all Epic 2 components)

## QA Results
_To be populated by QA agent_
