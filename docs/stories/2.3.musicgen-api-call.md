# Story 2.3: Implement Replicate API Call for MusicGen-Chord

## Status
Draft

## Story
**As a** developer,
**I want** a function that sends vibe descriptions to MusicGen-Chord API,
**so that** I receive AI-generated chord progressions and tempo.

## Acceptance Criteria
1. Function accepts vibe string as parameter
2. API request includes vibe as text prompt to MusicGen-Chord
3. Request specifies chord output format (text-based chord notation)
4. Function returns Promise with API response
5. Error handling catches network failures and API errors
6. TypeScript types defined for API request and response

## Tasks / Subtasks
- [ ] Define TypeScript types for API (AC: 6)
  - [ ] Create `src/types/musicgen.ts` for type definitions
  - [ ] Define MusicGenChordInput interface
  - [ ] Define MusicGenChordResponse interface
  - [ ] Define error types for API failures
- [ ] Create API call function (AC: 1, 2, 3, 4)
  - [ ] Create `src/lib/musicgen.ts` for API logic
  - [ ] Import Replicate client from `src/lib/replicate.ts`
  - [ ] Implement `generateChords(vibe: string)` function
  - [ ] Configure MusicGen-Chord model parameters
  - [ ] Specify chord notation format in prompt
  - [ ] Return typed Promise with response
- [ ] Implement error handling (AC: 5)
  - [ ] Wrap API call in try-catch block
  - [ ] Handle network timeout errors
  - [ ] Handle API rate limit errors
  - [ ] Handle invalid response format errors
  - [ ] Log errors for debugging
  - [ ] Return user-friendly error messages
- [ ] Test API integration (AC: 1-6)
  - [ ] Test with valid vibe input
  - [ ] Test with empty string (should reject)
  - [ ] Test with network timeout scenario
  - [ ] Verify response matches TypeScript types

## Dev Notes

### Tech Stack Reference
- **API**: Replicate MusicGen-Chord model
- **Client**: Replicate SDK (from Story 2.1)
- **Types**: TypeScript for type safety
- **Error Handling**: Try-catch with typed errors

### Type Definitions
```typescript
// src/types/musicgen.ts
export interface MusicGenChordInput {
  prompt: string;
  duration?: number;
  temperature?: number;
  top_k?: number;
  top_p?: number;
  chord_format?: 'text' | 'json';
}

export interface MusicGenChordResponse {
  output: string | string[];
  status: 'succeeded' | 'failed' | 'processing';
  error?: string;
}

export interface ChordGenerationError {
  code: 'NETWORK_ERROR' | 'API_ERROR' | 'TIMEOUT' | 'INVALID_RESPONSE';
  message: string;
  originalError?: unknown;
}
```

### API Call Implementation
```typescript
// src/lib/musicgen.ts
import { replicateClient } from './replicate';
import type {
  MusicGenChordInput,
  MusicGenChordResponse,
  ChordGenerationError
} from '@/types/musicgen';

const MUSICGEN_CHORD_MODEL = 'sakemin/musicgen-chord:latest';
const REQUEST_TIMEOUT_MS = 90000; // 90 seconds

export async function generateChords(
  vibe: string
): Promise<MusicGenChordResponse> {
  if (!vibe.trim()) {
    throw new Error('Vibe description cannot be empty');
  }

  const input: MusicGenChordInput = {
    prompt: `Generate chord progression for: ${vibe}. Output as text chord notation.`,
    duration: 30,
    temperature: 0.8,
    chord_format: 'text',
  };

  try {
    const output = await Promise.race([
      replicateClient.run(MUSICGEN_CHORD_MODEL, { input }),
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Request timeout')), REQUEST_TIMEOUT_MS)
      ),
    ]);

    return {
      output: output as string | string[],
      status: 'succeeded',
    };
  } catch (error) {
    const chordError: ChordGenerationError = {
      code: error instanceof Error && error.message === 'Request timeout'
        ? 'TIMEOUT'
        : 'API_ERROR',
      message: error instanceof Error ? error.message : 'Unknown error occurred',
      originalError: error,
    };

    console.error('MusicGen-Chord API error:', chordError);
    throw chordError;
  }
}
```

### MusicGen-Chord Parameters
- **prompt**: Vibe description + instruction for chord notation output
- **duration**: Audio duration in seconds (30s default)
- **temperature**: Randomness (0.8 for creative variety)
- **chord_format**: 'text' for parseable chord notation
- **top_k/top_p**: Optional sampling parameters

### Error Scenarios
1. **Network Error**: No internet connection, DNS failure
2. **API Error**: Invalid API token, rate limit exceeded
3. **Timeout**: Request exceeds 90 seconds
4. **Invalid Response**: Malformed output from API

### Timeout Strategy
- 90-second timeout (per PRD requirement)
- Promise.race() pattern for timeout implementation
- Timeout error caught and converted to user-friendly message

### Prompt Engineering
Format vibe description to ensure chord notation output:
- "Generate chord progression for: [vibe]. Output as text chord notation."
- Explicit instruction for text format increases parse reliability
- Consider adding example format in prompt if needed

### Testing
Manual validation:
1. Call `generateChords("happy summer day")` → should return chord data
2. Call `generateChords("")` → should throw error
3. Test with long vibe description
4. Monitor console for error logging

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 0.1 | Initial story creation from PRD Epic 2 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
**Created:**
_To be populated by dev agent_

**Modified:**
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
