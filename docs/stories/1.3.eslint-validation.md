# Story 1.3: Set Up ESLint and Validation Gates

## Status
Ready for Review

## Story
**As a** developer,
**I want** ESLint configured with TypeScript rules and pre-commit hooks,
**so that** code quality is maintained automatically before commits.

## Acceptance Criteria
1. ESLint installed with TypeScript plugin
2. ESLint config includes recommended TypeScript rules
3. `npm run lint` script added and passes
4. Husky installed for Git hooks
5. Pre-commit hook runs `typecheck && lint` (must pass to commit)
6. Hook execution time <5 seconds for developer ergonomics

## Tasks / Subtasks
- [x] Install ESLint with TypeScript support (AC: 1)
  - [x] Install ESLint v9.0.0+
  - [x] Install TypeScript ESLint parser and plugin
  - [x] Verify ESLint CLI works: `npx eslint --version`
- [x] Configure ESLint rules (AC: 2)
  - [x] Create `eslint.config.js` with TypeScript-aware rules
  - [x] Enable recommended TypeScript rules
  - [x] Configure React hooks rules
  - [x] Add unused variable warnings
  - [x] Test configuration with sample file
- [x] Add lint script to package.json (AC: 3)
  - [x] Add `"lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0"`
  - [x] Add `"lint:fix": "eslint . --ext ts,tsx --fix"`
  - [x] Run `npm run lint` and verify passes
  - [x] Test `npm run lint:fix` auto-fixes issues
- [x] Install and configure Husky (AC: 4)
  - [x] Install Husky v9.0.0+
  - [x] Initialize Husky: `npx husky init`
  - [x] Verify `.husky/` directory created
- [x] Set up pre-commit hook (AC: 5)
  - [x] Create `.husky/pre-commit` hook
  - [x] Add commands: `npm run typecheck && npm run lint`
  - [x] Make hook executable: `chmod +x .husky/pre-commit`
  - [x] Test hook blocks commit on lint failure
  - [x] Test hook allows commit on success
- [x] Optimize hook performance (AC: 6)
  - [x] Time hook execution: should be <5 seconds
  - [x] If slow, consider lint-staged for partial file checking
  - [x] Document expected execution time in README

## Dev Notes

### ESLint Configuration
From ui-architecture.md:
- **Version**: ESLint v9.0.0+ (flat config format)
- **TypeScript-aware**: Must use @typescript-eslint parser
- **React-aware**: Must include React hooks rules

### ESLint Config Template
```javascript
// eslint.config.js
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'

export default tseslint.config(
  { ignores: ['dist'] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ['**/*.{ts,tsx}'],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
      '@typescript-eslint/no-unused-vars': ['warn', { argsIgnorePattern: '^_' }],
      '@typescript-eslint/no-explicit-any': 'error',
    },
  },
)
```

### npm Scripts to Add
```json
{
  "scripts": {
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "lint:fix": "eslint . --ext ts,tsx --fix"
  }
}
```

### Husky Pre-Commit Hook
```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run TypeScript validation
npm run typecheck

# Run ESLint validation
npm run lint
```

### Dependencies to Install
```bash
npm install -D eslint@^9.0.0 \
  @eslint/js \
  globals \
  eslint-plugin-react-hooks \
  eslint-plugin-react-refresh \
  typescript-eslint

npm install -D husky@^9.0.0
```

### Git Workflow Integration
From prd.md:
- **Pre-Commit Validation Gate**: typecheck + lint must pass
- **Fast Execution**: <5 seconds to avoid developer friction
- **Progressive Commits**: Frequent commits with validated quality

### Performance Considerations
If hook execution exceeds 5 seconds:
1. Consider `lint-staged` for partial file linting
2. Use incremental TypeScript checking
3. Document performance in README

### Testing the Hooks
1. **Intentional Failure Test**:
   - Add `const unused: any = 5` to test file
   - Try to commit
   - Should fail with ESLint error

2. **Success Test**:
   - Fix the error
   - Commit should succeed

3. **Bypass Test**:
   - Verify `git commit --no-verify` works for emergencies

### Common ESLint Rules for Audio/Music App
- No `any` types (critical for music theory types)
- Warn on unused variables
- Enforce React hooks rules
- Prefer const over let
- No console.log in production builds (warn only)

## Testing
Validation through:
1. `npm run lint` passes with zero errors
2. `npm run lint:fix` auto-fixes formatting issues
3. Pre-commit hook blocks commits with lint errors
4. Pre-commit hook allows commits with clean code
5. Hook execution time measured and <5 seconds

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 0.1 | Initial story creation from PRD Epic 1 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None - no issues encountered

### Completion Notes List
- ESLint was already installed by Vite template (v9.36.0)
- Enhanced eslint.config.js with stricter TypeScript rules:
  - Added @typescript-eslint/no-explicit-any: 'error' (critical for music theory types)
  - Added @typescript-eslint/no-unused-vars: 'warn' with ignore pattern for _prefixed vars
  - Configured React hooks rules and React refresh plugin
- Added lint:fix script to package.json
- Installed Husky v9.1.7 for git hooks
- Created pre-commit hook with typecheck && lint validation
- Tested hook successfully blocks commits with lint errors
- Hook execution time: ~0.96 seconds (well under 5 second requirement)
- All validation gates working correctly

### File List
**Modified:**
- `eslint.config.js` - Enhanced with stricter TypeScript and React rules
- `package.json` - Added lint:fix script, added Husky dependency
- `package-lock.json` - Updated with Husky dependencies
- `docs/stories/1.3.eslint-validation.md` - Updated status and tasks

**Created:**
- `.husky/pre-commit` - Pre-commit hook running typecheck && lint
- `.husky/_/` - Husky internal directory

## QA Results
_To be populated by QA agent_
