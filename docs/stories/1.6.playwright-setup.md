# Story 1.6: Set Up Playwright for E2E Testing

## Status
Complete

## Story
**As a** developer,
**I want** Playwright configured to run E2E tests against the Vite dev server,
**so that** I can validate critical user flows before deployment.

## Acceptance Criteria
1. Playwright installed with TypeScript support
2. `playwright.config.ts` configured with port 8420 web server
3. Test directory created at `tests/e2e/`
4. Smoke test written: app loads and renders basic UI
5. `npm run test:e2e` script runs tests successfully
6. `npm run test:e2e:ui` opens Playwright UI for debugging

## Tasks / Subtasks
- [x] Install Playwright (AC: 1)
  - [x] Install `@playwright/test` package
  - [x] Install browser binaries (Chromium only for hackathon)
  - [x] Verify Playwright CLI works: `npx playwright --version`
- [x] Configure Playwright (AC: 2)
  - [x] Create `playwright.config.ts` with correct web server config
  - [x] Set baseURL to `http://localhost:8420`
  - [x] Configure web server command: `npm run dev`
  - [x] Set test timeout to 120s for server start
  - [x] Note audio permissions for future audio context tests
- [x] Create test directory structure (AC: 3)
  - [x] Create `tests/e2e/` directory
- [x] Write smoke test (AC: 4)
  - [x] Create `tests/e2e/smoke.spec.ts`
  - [x] Test: App loads and shows component showcase title
  - [x] Test: Button components render with pastel horror styling
  - [x] Test: Input field renders with placeholder text
  - [x] Test: Pastel horror background color applied
  - [x] Test: Card components display correctly
  - [x] Test: Page has proper structure and layout
- [x] Add npm scripts (AC: 5, 6)
  - [x] Add `"test:e2e": "playwright test"`
  - [x] Add `"test:e2e:ui": "playwright test --ui"`
  - [x] Add `"test:e2e:headed": "playwright test --headed"`
  - [x] Add `"test:e2e:debug": "playwright test --debug"`
  - [x] Run `npm run test:e2e` and verify passes (6 tests passing)

## Dev Notes

### Playwright Configuration
From PRD Technical Assumptions:
- **Version**: Playwright ^1.47.0
- **MCP Integration**: Playwright MCP available in Claude Code
- **Testing Strategy**: E2E only (no unit tests for hackathon)
- **Test Coverage**: Critical flows (input → generate → playback)

### Playwright Config Template
```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  
  use: {
    baseURL: 'http://localhost:8420',
    trace: 'on-first-retry',
    permissions: ['audio-capture'], // Required for audio tests
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    // Skip Firefox/Safari for hackathon speed
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:8420',
    reuseExistingServer: !process.env.CI,
    timeout: 120000, // 2 minutes for server start
  },
})
```

### Smoke Test Template
```typescript
// tests/e2e/smoke.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Smoke Tests', () => {
  test('app loads and renders vibe input', async ({ page }) => {
    await page.goto('/')

    // Check title
    await expect(page).toHaveTitle(/Vibe Translator/)

    // Check vibe input field renders
    const input = page.getByPlaceholder(/vibe/i)
    await expect(input).toBeVisible()

    // Check submit button
    const button = page.getByRole('button', { name: /generate/i })
    await expect(button).toBeVisible()
  })

  test('pastel horror theme applied', async ({ page }) => {
    await page.goto('/')

    // Check background color (horror-butter)
    const body = page.locator('body')
    const bgColor = await body.evaluate(el =>
      window.getComputedStyle(el).backgroundColor
    )
    
    // Verify it's not default white
    expect(bgColor).not.toBe('rgb(255, 255, 255)')
    expect(bgColor).toBeTruthy()
  })

  test('components are interactive', async ({ page }) => {
    await page.goto('/')

    // Test input accepts text
    const input = page.getByPlaceholder(/vibe/i)
    await input.fill('happy coding vibes')
    await expect(input).toHaveValue('happy coding vibes')

    // Test button is clickable
    const button = page.getByRole('button', { name: /generate/i })
    await expect(button).toBeEnabled()
  })
})
```

### npm Scripts to Add
```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:debug": "playwright test --debug"
  }
}
```

### Test Execution Points
From PRD:
- **During Development**: Manual Playwright runs for debugging
- **Pre-Commit**: TypeScript + ESLint only (fast gates)
- **Pre-Push**: Full Playwright suite (comprehensive validation)
- **Pre-Deploy**: Full test suite + visual regression checks

### Audio Context Permissions
Critical for audio tests:
```typescript
use: {
  permissions: ['audio-capture'], // Required for Tone.js tests
}
```

### Future Test Files (Upcoming Stories)
```
tests/e2e/
├── smoke.spec.ts           # Story 1.6 (this story)
├── generation.spec.ts      # Story 2.x (API integration)
├── audio.spec.ts           # Story 3.x (audio playback)
├── effects.spec.ts         # Story 4.x (DJ effects)
└── visual.spec.ts          # Story 5.x (visual polish)
```

### Playwright MCP Integration
From PRD:
- Use Playwright MCP for test writing and debugging
- Leverage Claude Code for rapid test authoring
- Real browser validation catches Web Audio API issues

### Common Playwright Patterns

**Waiting for Elements**:
```typescript
await expect(page.getByRole('button')).toBeVisible()
await page.waitForSelector('.audio-control')
```

**Testing Interactions**:
```typescript
await page.click('button')
await page.fill('input', 'text')
await page.selectOption('select', 'value')
```

**Audio Context Testing**:
```typescript
// Grant audio permissions
await context.grantPermissions(['audio-capture'])

// Check audio context created
const audioState = await page.evaluate(() => {
  return (window as any).audioContext?.state
})
expect(audioState).toBe('running')
```

### Test Directory Structure
After setup:
```
tests/
└── e2e/
    ├── smoke.spec.ts
    └── (future test files)
```

### Playwright Reports
- HTML report generated at `playwright-report/`
- Add to `.gitignore`
- View with `npx playwright show-report`

### Performance Considerations
- **Chromium Only**: Skip Firefox/Safari for hackathon speed
- **Parallel Execution**: fullyParallel: true for faster test runs
- **Retries**: 2 retries in CI, 0 locally for fast feedback

### Debugging Tests
```bash
# UI mode (recommended)
npm run test:e2e:ui

# Headed mode (see browser)
npm run test:e2e:headed

# Debug mode (step through)
npm run test:e2e:debug

# Specific test file
npx playwright test smoke.spec.ts
```

## Testing
Validation through:
1. `npx playwright --version` shows installed version
2. `playwright.config.ts` exists and configured
3. `tests/e2e/smoke.spec.ts` created
4. `npm run test:e2e` runs and passes all smoke tests
5. `npm run test:e2e:ui` opens Playwright UI
6. No console errors during test execution

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 0.1 | Initial story creation from PRD Epic 1 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Initial installation attempted with `npm init playwright@latest` but encountered interactive prompts
- Switched to manual installation: `npm install --save-dev @playwright/test@latest`
- Browser binaries installed with: `npx playwright install chromium`
- Fixed audio permission error by removing unsupported `audio-capture` permission (noted for future)
- Tests initially failed due to app structure changes - updated tests to match ComponentShowcase
- All 6 smoke tests passing in 1.2s

### Completion Notes List
1. **Playwright Version**: @playwright/test@1.56.1 installed
2. **Browser**: Chromium only (optimized for hackathon speed)
3. **Configuration**: playwright.config.ts configured for port 8420 with 120s server timeout
4. **Audio Permissions**: Noted for future Tone.js tests but not enabled yet (unsupported permission name)
5. **Test Structure**: 6 smoke tests covering:
   - App loading and component showcase rendering
   - Pastel horror theme background verification
   - Button components with pastel horror styling
   - Input components with placeholder text interaction
   - Card components display (DJ Effects, Tempo Control, Volume Mix)
   - Page structure and layout validation
6. **npm Scripts**: Added test:e2e, test:e2e:ui, test:e2e:headed, test:e2e:debug
7. **Test Results**: All tests passing (6/6) in 1.2s

### File List
- `/Users/josh/projects/aimusic/playwright.config.ts` (created)
- `/Users/josh/projects/aimusic/tests/e2e/smoke.spec.ts` (created)
- `/Users/josh/projects/aimusic/package.json` (modified - added scripts and @playwright/test dependency)
- `/Users/josh/projects/aimusic/docs/stories/1.6.playwright-setup.md` (updated - marked complete)

## QA Results
_To be populated by QA agent_
